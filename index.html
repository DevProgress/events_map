<!DOCTYPE html>
<html>
  <head>
    <title>H Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/styles.css">
  </head>
  <body>
    <div id="map"></div>
    <a href="https://www.hillaryclinton.com/" target="_blank"><img id="logo" src="images/logo.svg"></a>
    <div id="info-box">
      <form id="zip-fields">
        <input type="text" name="zip" id="zip" maxlength="5" pattern="[0-9]*">
        <input type="submit" id="go-btn" value="GO">
        <br>
        <a href="javascript:void(0)" id="locate-me">(my location)</a>
      </form>
      <div id="legend">
      </div>
    </div>
    <script src="js/variables.js"></script>
    <script>

      var map;
      var event_types = {};
      var hillary_polygon, logo_overlay;
      var data_layer = {};

      // This hash will split all events into separate categories based on title
      function initEventTypes() {
        event_types = {
          'Voter Registration': {icon: 'http://maps.google.com/mapfiles/kml/paddle/red-circle.png', keywords: ['voter registration']},
          'Party': {icon: 'http://maps.google.com/mapfiles/kml/paddle/grn-circle.png', keywords: ['party', 'fest']},
          'Phone Bank': {icon: 'http://maps.google.com/mapfiles/kml/paddle/blu-circle.png', keywords: ['phone bank', 'phonebank']},
          'Other': {icon: 'http://maps.google.com/mapfiles/kml/paddle/wht-circle.png'}
        };
      }

      // Set up legend
      function initLegend() {
        var legend = document.getElementById('legend');
        for (var key in event_types) {
          legend.appendChild(document.createElement("br"));
          var icon = document.createElement('img');
          icon.className = 'legend-icon';
          icon.dataset.key = key;
          icon.dataset.visible = 'true';
          icon.src = event_types[key].icon;
          legend.appendChild(document.createTextNode(key));
          legend.appendChild(icon);
          icon.addEventListener('click', function(event) {
            if (event.target.dataset.visible == 'true') {
              data_layer[event.target.dataset.key].setMap(null);
              event.target.dataset.visible = 'false';
            } else {
              data_layer[event.target.dataset.key].setMap(map);
              event.target.dataset.visible = 'true';
            }
          });
        }
      }

      function setHQShapes() {
        var hillary_HQ = [
          {lat: 40.696118, lng: -73.991529},
          {lat: 40.696173, lng: -73.991233},
          {lat: 40.694589, lng: -73.990748},
          {lat: 40.694956, lng: -73.992074},
          {lat: 40.696118, lng: -73.991529}
        ];
        hillary_polygon = new google.maps.Polygon({
          paths: hillary_HQ,
          strokeColor: '#254DA3',
          strokeOpacity: 0.8,
          strokeWeight: 4,
          fillColor: '#E51B2D',
          fillOpacity: 0.5
        });
        var hillary_logo = {
          north: 40.695355,
          south: 40.694962,
          east: -73.9911495,
          west: -73.991608
        };
        logo_overlay = new google.maps.GroundOverlay('images/logo.svg', hillary_logo);
        google.maps.event.addListener(hillary_polygon, 'click', function() {
          window.open('http://www.amny.com/news/elections/hillary-clinton-s-brooklyn-campaign-headquarters-inside-her-quirky-nyc-office-1.11619335', '_blank');
        });
      }

      function findEventsNearby(location) {
        window.open(window.location.href + '?lat=' + location.coords.latitude + '&lng=' + location.coords.longitude, '_self');
      }

      // Take a given event from the HillaryClinton.com API and turn it into a GeoJSON marker with relevant properties
      function fillEventProperties(hillary_event) {
        return {"type": "Feature",
          "geometry": {"type": "Point",
            "coordinates": [Number(hillary_event.locations[0].longitude),Number(hillary_event.locations[0].latitude)]
          },
          "properties": {
            "title": hillary_event.name,
            "description": hillary_event.description,
            "start_date": hillary_event.startDate,
            "end_date": hillary_event.endDate,
            "lookup_id": hillary_event.lookupId
          }
        };
      }

      // Convert the HillaryClinton.com API results into a JSON object containing one or more GeoJSON layers
      function HillaryToHashOfGeoJSONs(json_string, split_by_event_type) { // json_string represents the HillaryClinton.com API results. split_by_event_type is a Boolean variable designating whether the results should be split by the event_types variable or just aggregated altogether regardless of event type.

        // Initialize return variable
        var geo_json = {};

        // Initialize variable indicating whether a given event has been categorized
        var has_event_type = false;

        // If each event type should be assigned to its own object key, then...
        if (split_by_event_type) {

          // Set up the keys for each event type in the geo_json variable that will be returned at the end of this function
          for (var key in event_types) {
            geo_json[key] = {"type": "FeatureCollection",
              "features": []
            };
          }

          // Loop through each event from the HillaryClinton.com API
          for (var i = 0; i < json_string.events.length; i++) {

            has_event_type = false;

            // Loop through each event type and determine whether this particular event belongs to one of them. If so, add its proprties to the appropriate geo_json key.
            for (var key in event_types) {
              if (key != 'Other') {

                for (var z = 0; z < event_types[key].keywords.length; z++) {
                  if (json_string.events[i].name.toLowerCase().includes(event_types[key].keywords[z].toLowerCase())) {
                    geo_json[key].features.push(fillEventProperties(json_string.events[i]));
                    has_event_type = true;

                    // Don't keep going: once you add this event to the correct category, break out of the inner loop.
                    break;
                  }
                }

                if (has_event_type) {
                  // Don't keep going: once you add this event to the correct category, break out of this loop.
                  break;
                }

              } else {
                geo_json[key].features.push(fillEventProperties(json_string.events[i]));
              }
            }

          }

          // Return the categorized events
          return geo_json;

        // If all event types should be grouped together without any separation...
        } else {

          // Set up geo_json to receive all events
          geo_json = {"type": "FeatureCollection",
            "features": []
          };

          // Loop through each event from the HillaryClinton.com API
          for (var i = 0; i < json_string.events.length; i++) {

            // Add the event properties to the geo_json variable
            geo_json.features.push(json_string.events[i]);

          }

          // Return the aggregated events
          return {'aggregated_layer': geo_json};

        }

      }

      // Initiate the map. This function is called as soon as the Google Maps JS finishes executing.
      function initMap() {

        initEventTypes();
        initLegend();
        setHQShapes();

        document.getElementById('locate-me').addEventListener('click', function() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(findEventsNearby);
          } else {
            alert('Geolocation is not enabled on this browser or site.');
          }
        });

        // Determine whether the URL query string includes a zip code. If so, get ready to look for events in that area.
        var query_str = window.location.search.substring(1).split("&");
        var lat_lng = [36.778261, -119.41793239999998];
        if (query_str.length > 0 && query_str[0].length > 0) {
          for (var i = 0; i < query_str.length; i++) {
            if (query_str[i].split("=")[0] == 'zip') {
              lat_lng = zip_to_lat[query_str[i].split("=")[1]];
              break;
            }
          }
        }

        // Initialize the new map with a center, zoom, and styles
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: lat_lng[0], lng: lat_lng[1]},
          zoom: 10,
          styles: [{"featureType":"landscape","stylers":[{"hue":"#F1FF00"},{"saturation":-27.4},{"lightness":9.4},{"gamma":1}]},{"featureType":"road.highway","stylers":[{"hue":"#E51B2D"},{"saturation":-20},{"lightness":36.4},{"gamma":1}]},{"featureType":"road.arterial","stylers":[{"hue":"#00FF4F"},{"saturation":0},{"lightness":0},{"gamma":1}]},{"featureType":"road.local","stylers":[{"hue":"#FFB300"},{"saturation":-38},{"lightness":11.2},{"gamma":1}]},{"featureType":"water","stylers":[{"hue":"#254DA3"},{"saturation":4.2},{"lightness":-63.4},{"gamma":1}]},{"featureType":"poi","stylers":[{"hue":"#9FFF00"},{"saturation":0},{"lightness":0},{"gamma":1}]}]
        });

        var infowindow = new google.maps.InfoWindow;

        var xhttp = new XMLHttpRequest();

        // This function only executes once the browser has received a response from the HillaryClinton.com API
        xhttp.onreadystatechange = function() {
          if (xhttp.readyState == 4 && xhttp.status == 200) {

            data_layer = {};

            var event_layers = HillaryToHashOfGeoJSONs(JSON.parse(xhttp.responseText), true);
            for (var layer in event_layers) {
              data_layer[layer] = new google.maps.Data();
              data_layer[layer].addGeoJson(event_layers[layer]);
              data_layer[layer].setStyle({
                icon: {url: event_types[layer].icon, scaledSize: new google.maps.Size(32, 32)}
              });
              data_layer[layer].setMap(map);
              data_layer[layer].addListener('click', function (event) {
                infowindow.setContent("<strong>" + event.feature.getProperty("title") + "</strong><br>" + event.feature.getProperty("description")+ "<br><a href='https://www.hillaryclinton.com/events/view/"+event.feature.getProperty("lookup_id")+"/' target='_blank'>RSVP</a>");
                infowindow.setPosition(event.feature.getGeometry().get());
                infowindow.open(map);
              });
            }

          }
        };

        // This calls the HillaryClinton.com API
        xhttp.open("GET", ("https://www.hillaryclinton.com/api/events/events?lat="+lat_lng[0]+"&lng="+lat_lng[1]+"&radius=50&earliestTime="+encodeURIComponent(new Date().toISOString())+"&status=confirmed&visibility=public&perPage=500&onepage=1&_=1467147104894"), true);
        xhttp.send();

        hillary_polygon.setMap(map);
        logo_overlay.setMap(map);

      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhUbn5cm5zOYo7-4l4l6ODZ-BesKiEnTo&callback=initMap" async defer></script>
  </body>
</html>
